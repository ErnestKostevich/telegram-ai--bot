#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
TELEGRAM AI BOT - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
"""

import asyncio
import logging
import json
import random
import time
import datetime
import re
import requests
import aiohttp
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field
import os
import sys
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.date import DateTrigger
from apscheduler.triggers.interval import IntervalTrigger
from newsapi import NewsApiClient
import nest_asyncio
from flask import Flask
import pytz
from github import Github

nest_asyncio.apply()

# Telegram Bot API
import telegram
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler, 
    filters, ContextTypes, CallbackQueryHandler
)
from telegram.constants import ChatType
from telegram.error import NetworkError, TimedOut

# Google Gemini
import google.generativeai as genai

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# =============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ö–û–ù–°–¢–ê–ù–¢–´
# =============================================================================

# API –∫–ª—é—á–∏ –∏–∑ env
BOT_TOKEN = os.getenv("BOT_TOKEN")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
CURRENCY_API_KEY = os.getenv("FREECURRENCY_API_KEY")
OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")
NEWSAPI_KEY = os.getenv("NEWSAPI_KEY")

# GitHub
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
GITHUB_REPO = "ErnestKostevich/telegram-ai--bot"
USERS_FILE = "users.json"
LOGS_FILE = "logs.json"
STATISTICS_FILE = "statistics.json"

# ID —Å–æ–∑–¥–∞—Ç–µ–ª—è –±–æ—Ç–∞
CREATOR_ID = 7108255346

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini
if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)

MODEL = os.getenv("MODEL", "gemini-2.0-flash-exp")

# Render URL –¥–ª—è –ø–∏–Ω–≥–∞
RENDER_URL = os.getenv("RENDER_EXTERNAL_URL", "https://telegram-ai--bot.onrender.com")

# =============================================================================
# –ö–õ–ê–°–°–´ –î–ê–ù–ù–´–•
# =============================================================================

@dataclass
class UserData:
    user_id: int
    username: str
    first_name: str
    is_vip: bool = False
    vip_expires: Optional[str] = None
    language: str = "ru"
    notes: List[str] = field(default_factory=list)
    reminders: List[Dict] = field(default_factory=list)
    birthday: Optional[str] = None
    nickname: Optional[str] = None
    level: int = 1
    experience: int = 0
    achievements: List[str] = field(default_factory=list)
    memory_data: Dict = field(default_factory=dict)
    theme: str = "default"
    last_activity: str = field(default_factory=lambda: datetime.datetime.now().isoformat())

    @classmethod
    def from_dict(cls, data: Dict):
        return cls(
            user_id=data['user_id'],
            username=data.get('username', ''),
            first_name=data.get('first_name', ''),
            is_vip=data.get('is_vip', False),
            vip_expires=data.get('vip_expires'),
            language=data.get('language', 'ru'),
            notes=data.get('notes', []),
            reminders=data.get('reminders', []),
            birthday=data.get('birthday'),
            nickname=data.get('nickname'),
            level=data.get('level', 1),
            experience=data.get('experience', 0),
            achievements=data.get('achievements', []),
            memory_data=data.get('memory_data', {}),
            theme=data.get('theme', 'default'),
            last_activity=data.get('last_activity', datetime.datetime.now().isoformat())
        )

    def to_dict(self):
        return {
            'user_id': self.user_id,
            'username': self.username,
            'first_name': self.first_name,
            'is_vip': self.is_vip,
            'vip_expires': self.vip_expires,
            'language': self.language,
            'notes': self.notes,
            'reminders': self.reminders,
            'birthday': self.birthday,
            'nickname': self.nickname,
            'level': self.level,
            'experience': self.experience,
            'achievements': self.achievements,
            'memory_data': self.memory_data,
            'theme': self.theme,
            'last_activity': self.last_activity
        }

# =============================================================================
# –ë–ê–ó–ê –î–ê–ù–ù–´–• (GitHub Files)
# =============================================================================

class DatabaseManager:
    def __init__(self):
        self.g = None
        self.repo = None
        self.users = []
        self.logs = []
        self.statistics = {}
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GitHub API
        if GITHUB_TOKEN:
            try:
                self.g = Github(GITHUB_TOKEN)
                self.repo = self.g.get_repo(GITHUB_REPO)
                logger.info("‚úÖ GitHub API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GitHub API: {e}")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        self.users = self.load_data(USERS_FILE, [])
        self.logs = self.load_data(LOGS_FILE, [])
        self.statistics = self.load_data(STATISTICS_FILE, {})
    
    def load_data(self, path, default):
        """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
        if not self.repo:
            logger.warning(f"GitHub –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è {path}")
            return default
            
        try:
            file = self.repo.get_contents(path)
            content = file.decoded_content.decode('utf-8')
            data = json.loads(content)
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if path == USERS_FILE and isinstance(data, dict) and not data:
                data = []
            elif path == STATISTICS_FILE and isinstance(data, list):
                data = {}
            elif path == LOGS_FILE and isinstance(data, dict) and not data:
                data = []
                
            logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ {path}")
            return data
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å {path}: {e}")
            return default
    
    def save_data(self, path, data):
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
        if not self.repo:
            logger.warning(f"GitHub –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {path}")
            return False
            
        try:
            content = json.dumps(data, ensure_ascii=False, indent=2)
            
            try:
                file = self.repo.get_contents(path)
                self.repo.update_file(path, f"Update {path}", content, file.sha)
            except:
                self.repo.create_file(path, f"Create {path}", content)
            
            logger.info(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {path}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ {path}: {e}")
            return False
    
    def get_user(self, user_id: int) -> Optional[UserData]:
        for user_dict in self.users:
            if user_dict.get('user_id') == user_id:
                return UserData.from_dict(user_dict)
        return None
    
    def get_user_by_username(self, username: str) -> Optional[UserData]:
        for user_dict in self.users:
            if user_dict.get('username') == username:
                return UserData.from_dict(user_dict)
        return None
    
    def save_user(self, user_data: UserData):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_data.last_activity = datetime.datetime.now().isoformat()
        
        if not isinstance(self.users, list):
            self.users = []
        
        for i, user_dict in enumerate(self.users):
            if user_dict.get('user_id') == user_data.user_id:
                self.users[i] = user_data.to_dict()
                break
        else:
            self.users.append(user_data.to_dict())
        
        self.save_data(USERS_FILE, self.users)
    
    def log_command(self, user_id: int, command: str, message: str = ""):
        log_entry = {
            'user_id': user_id,
            'command': command,
            'message': message,
            'timestamp': datetime.datetime.now().isoformat()
        }
        
        self.logs.append(log_entry)
        
        if len(self.logs) > 1000:
            self.logs = self.logs[-1000:]
        
        if command in self.statistics:
            self.statistics[command]['usage_count'] += 1
            self.statistics[command]['last_used'] = datetime.datetime.now().isoformat()
        else:
            self.statistics[command] = {
                'usage_count': 1,
                'last_used': datetime.datetime.now().isoformat()
            }
        
        asyncio.create_task(self._save_logs_async())
    
    async def _save_logs_async(self):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤"""
        await asyncio.get_event_loop().run_in_executor(
            None, self.save_data, LOGS_FILE, self.logs
        )
        await asyncio.get_event_loop().run_in_executor(
            None, self.save_data, STATISTICS_FILE, self.statistics
        )
    
    def get_all_users(self) -> List[tuple]:
        return [(u.get('user_id'), u.get('first_name', 'Unknown'), u.get('level', 1), u.get('last_activity', '')) for u in self.users]
    
    def get_vip_users(self) -> List[tuple]:
        return [(u.get('user_id'), u.get('first_name', 'Unknown'), u.get('vip_expires')) for u in self.users if u.get('is_vip')]
    
    def get_popular_commands(self) -> List[tuple]:
        return sorted(self.statistics.items(), key=lambda x: x[1]['usage_count'], reverse=True)[:10]

# =============================================================================
# –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° –ë–û–¢–ê
# =============================================================================

class TelegramBot:
    def __init__(self):
        self.db = DatabaseManager()
        self.gemini_model = None
        if GEMINI_API_KEY:
            try:
                self.gemini_model = genai.GenerativeModel(MODEL)
                logger.info("‚úÖ Gemini –º–æ–¥–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini: {e}")
        
        self.user_contexts = {}
        self.scheduler = AsyncIOScheduler()
        self.maintenance_mode = False
    
    async def get_user_data(self, update: Update) -> UserData:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = update.effective_user
        user_data = self.db.get_user(user.id)
        
        if not user_data:
            user_data = UserData(
                user_id=user.id,
                username=user.username or "",
                first_name=user.first_name or ""
            )
            
            if self.is_creator(user.id):
                user_data.is_vip = True
                user_data.vip_expires = None
                logger.info(f"‚úÖ –°–æ–∑–¥–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VIP: {user.id}")
            
            self.db.save_user(user_data)
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.id} ({user.first_name})")
        
        return user_data
    
    def is_creator(self, user_id: int) -> bool:
        return user_id == CREATOR_ID
    
    def is_vip(self, user_data: UserData) -> bool:
        if not user_data.is_vip:
            return False
        
        if user_data.vip_expires:
            try:
                expires_date = datetime.datetime.fromisoformat(user_data.vip_expires)
                if datetime.datetime.now() > expires_date:
                    user_data.is_vip = False
                    user_data.vip_expires = None
                    self.db.save_user(user_data)
                    return False
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ VIP: {e}")
                return False
        
        return True
    
    async def add_experience(self, user_data: UserData, points: int = 1):
        user_data.experience += points
        
        required_exp = user_data.level * 100
        if user_data.experience >= required_exp:
            user_data.level += 1
            user_data.experience = 0
            achievement = f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç {user_data.level} —É—Ä–æ–≤–µ–Ω—å!"
            if achievement not in user_data.achievements:
                user_data.achievements.append(achievement)
        
        self.db.save_user(user_data)
    
    async def send_notification(self, context: ContextTypes.DEFAULT_TYPE, user_id: int, message: str):
        try:
            await context.bot.send_message(chat_id=user_id, text=message)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

    # =============================================================================
    # –ë–ê–ó–û–í–´–ï –ö–û–ú–ê–ù–î–´
    # =============================================================================

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/start")
        
        if self.is_creator(user_data.user_id):
            message = """
üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –°–æ–∑–¥–∞—Ç–µ–ª—å!

üëë –ö–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞—Ç–µ–ª—è:
‚Ä¢ /grant_vip - –í—ã–¥–∞—Ç—å VIP
‚Ä¢ /revoke_vip - –û—Ç–æ–∑–≤–∞—Ç—å VIP
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞
‚Ä¢ /broadcast - –†–∞—Å—Å—ã–ª–∫–∞
‚Ä¢ /users - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ /maintenance - –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
‚Ä¢ /backup - –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
‚Ä¢ /logs - –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ /cleanup - –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö

ü§ñ /help - –í—Å–µ –∫–æ–º–∞–Ω–¥—ã
            """
        elif self.is_vip(user_data):
            nickname = user_data.nickname or user_data.first_name
            expires_text = '–±–µ—Å—Å—Ä–æ—á–Ω–æ'
            if user_data.vip_expires:
                try:
                    expires_date = datetime.datetime.fromisoformat(user_data.vip_expires)
                    expires_text = expires_date.strftime('%d.%m.%Y')
                except:
                    expires_text = '–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'
            
            message = f"""
üíé –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {nickname}!
VIP –¥–æ: {expires_text}

‚≠ê VIP –∫–æ–º–∞–Ω–¥—ã:
‚Ä¢ /remind - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
‚Ä¢ /vipstats - VIP —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ /priority - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
‚Ä¢ /profile - –ü—Ä–æ—Ñ–∏–ª—å
‚Ä¢ /nickname - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∏–∫

ü§ñ /help - –í—Å–µ –∫–æ–º–∞–Ω–¥—ã
            """
        else:
            message = f"""
ü§ñ –ü—Ä–∏–≤–µ—Ç, {user_data.first_name}!

–Ø AI-–±–æ—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ñ—É–Ω–∫—Ü–∏–π!

üåü –û—Å–Ω–æ–≤–Ω—ã–µ:
‚Ä¢ üí¨ AI-—á–∞—Ç (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ)
‚Ä¢ üìù –ó–∞–º–µ—Ç–∫–∏ (/note)
‚Ä¢ üß† –ü–∞–º—è—Ç—å (/memorysave)
‚Ä¢ üå§Ô∏è –ü–æ–≥–æ–¥–∞ (/weather)
‚Ä¢ üí∞ –í–∞–ª—é—Ç—ã (/currency)
‚Ä¢ üéÆ –ò–≥—Ä—ã (/coin, /dice, /quiz)

üíé –•–æ—Ç–∏—Ç–µ VIP? –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º!
ü§ñ /help - –í—Å–µ –∫–æ–º–∞–Ω–¥—ã
            """
        
        keyboard = [
            [InlineKeyboardButton("üìã –ü–æ–º–æ—â—å", callback_data="help"),
             InlineKeyboardButton("üíé VIP", callback_data="vip_info")],
            [InlineKeyboardButton("ü§ñ AI", callback_data="ai_demo"),
             InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="my_stats")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(message, reply_markup=reply_markup)
        await self.add_experience(user_data, 1)

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/help")
        
        # –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö
        help_text = """
üìã –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê

üè† –ë–ê–ó–û–í–´–ï:
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/info - –û –±–æ—Ç–µ
/status - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
/rank - –í–∞—à —É—Ä–æ–≤–µ–Ω—å

üí¨ AI-–ß–ê–¢:
/ai [–≤–æ–ø—Ä–æ—Å] - –í–æ–ø—Ä–æ—Å AI
–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ!

üìù –ó–ê–ú–ï–¢–ö–ò:
/note [—Ç–µ–∫—Å—Ç] - –°–æ–∑–¥–∞—Ç—å
/notes - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
/delnote [–Ω–æ–º–µ—Ä] - –£–¥–∞–ª–∏—Ç—å
/findnote [—Å–ª–æ–≤–æ] - –ü–æ–∏—Å–∫
/clearnotes - –û—á–∏—Å—Ç–∏—Ç—å

üß† –ü–ê–ú–Ø–¢–¨:
/memorysave [–∫–ª—é—á] [–∑–Ω–∞—á–µ–Ω–∏–µ]
/memoryget [–∫–ª—é—á]
/memorylist - –°–ø–∏—Å–æ–∫
/memorydel [–∫–ª—é—á] - –£–¥–∞–ª–∏—Ç—å

‚è∞ –í–†–ï–ú–Ø:
/time - –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
/date - –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞

üéÆ –†–ê–ó–í–õ–ï–ß–ï–ù–ò–Ø:
/joke - –®—É—Ç–∫–∞
/fact - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç
/quote - –¶–∏—Ç–∞—Ç–∞
/quiz - –í–∏–∫—Ç–æ—Ä–∏–Ω–∞
/coin - –ú–æ–Ω–µ—Ç–∫–∞
/dice - –ö—É–±–∏–∫
/8ball [–≤–æ–ø—Ä–æ—Å] - –®–∞—Ä

üî¢ –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê:
/math [–≤—ã—Ä–∞–∂–µ–Ω–∏–µ]
/calculate [–≤—ã—Ä–∞–∂–µ–Ω–∏–µ]

üõ†Ô∏è –£–¢–ò–õ–ò–¢–´:
/password [–¥–ª–∏–Ω–∞] - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä
/qr [—Ç–µ–∫—Å—Ç] - QR-–∫–æ–¥
/shorturl [—Å—Å—ã–ª–∫–∞] - –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ
/ip - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± IP
/weather [–≥–æ—Ä–æ–¥] - –ü–æ–≥–æ–¥–∞
/currency [–∏–∑] [–≤] - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä
/translate [—è–∑—ã–∫] [—Ç–µ–∫—Å—Ç]
        """
        
        # VIP –∫–æ–º–∞–Ω–¥—ã
        if self.is_vip(user_data):
            help_text += """
üíé VIP –ö–û–ú–ê–ù–î–´:
/vip - VIP —Å—Ç–∞—Ç—É—Å
/remind [–º–∏–Ω] [—Ç–µ–∫—Å—Ç] - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
/reminders - –°–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
/delreminder [–Ω–æ–º–µ—Ä] - –£–¥–∞–ª–∏—Ç—å
/nickname [–∏–º—è] - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∏–∫
/profile - –ü—Ä–æ—Ñ–∏–ª—å
/vipstats - VIP —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/priority - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
            """
        
        # –ö–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞—Ç–µ–ª—è
        if self.is_creator(user_data.user_id):
            help_text += """
üëë –ö–û–ú–ê–ù–î–´ –°–û–ó–î–ê–¢–ï–õ–Ø:
/grant_vip [id/@username] [week/month/year/permanent]
/revoke_vip [id/@username]
/broadcast [—Ç–µ–∫—Å—Ç] - –†–∞—Å—Å—ã–ª–∫–∞
/users - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
/stats - –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/maintenance [on/off] - –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
/backup - –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
/logs - –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
/cleanup - –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
/systeminfo - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
/resetuser [id] - –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            """
        
        await update.message.reply_text(help_text)
        await self.add_experience(user_data, 1)

    async def info_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/info")
        
        info_text = f"""
ü§ñ –û –ë–û–¢–ï

–í–µ—Ä—Å–∏—è: 2.1
–°–æ–∑–¥–∞—Ç–µ–ª—å: Ernest
–§—É–Ω–∫—Ü–∏–π: 50+
AI: {"Gemini 2.0 ‚úÖ" if self.gemini_model else "‚ùå"}
–ë–∞–∑–∞: {"GitHub ‚úÖ" if self.db.repo else "–õ–æ–∫–∞–ª—å–Ω–∞—è"}
–•–æ—Å—Ç–∏–Ω–≥: Render

–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7
        """
        await update.message.reply_text(info_text)
        await self.add_experience(user_data, 1)

    async def status_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/status")
        
        total_users = len(self.db.users)
        total_commands = len(self.db.logs)
        
        status_text = f"""
‚ö° –°–¢–ê–¢–£–° –ë–û–¢–ê

–û–Ω–ª–∞–π–Ω: ‚úÖ
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}
–ö–æ–º–∞–Ω–¥: {total_commands}
Gemini: {"‚úÖ" if self.gemini_model else "‚ùå"}
GitHub: {"‚úÖ" if self.db.repo else "‚ùå"}
–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ: {"–í–∫–ª" if self.maintenance_mode else "–í—ã–∫–ª"}
        """
        await update.message.reply_text(status_text)
        await self.add_experience(user_data, 1)

    # ==================== –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –í –°–õ–ï–î–£–Æ–©–ï–ô –ß–ê–°–¢–ò ====================
    # –î–æ–±–∞–≤–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã...

    async def ai_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/ai")
        
        if not context.args:
            await update.message.reply_text("ü§ñ –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ /ai\n–ü—Ä–∏–º–µ—Ä: /ai –ß—Ç–æ —Ç–∞–∫–æ–µ Python?")
            return
        
        if not self.gemini_model:
            await update.message.reply_text("‚ùå AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. Gemini API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
            return
        
        query = " ".join(context.args)
        try:
            await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
            
            response = self.gemini_model.generate_content(query)
            await update.message.reply_text(response.text)
            await self.add_experience(user_data, 2)
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ AI: {str(e)}")
            logger.error(f"–û—à–∏–±–∫–∞ Gemini: {e}")

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        if self.maintenance_mode and not self.is_creator(update.effective_user.id):
            await update.message.reply_text("üõ† –ë–æ—Ç –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return
        
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "message")
        
        if not self.gemini_model:
            await update.message.reply_text("‚ùå AI-—á–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã!")
            return
        
        message = update.message.text
        user_id = user_data.user_id
        
        if user_id not in self.user_contexts:
            self.user_contexts[user_id] = []
        
        self.user_contexts[user_id].append(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message}")
        if len(self.user_contexts[user_id]) > 10:
            self.user_contexts[user_id] = self.user_contexts[user_id][-10:]
        
        context_str = "\n".join(self.user_contexts[user_id][-5:])
        prompt = f"""
–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram –±–æ—Ç–µ. 
–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:
{context_str}

–û—Ç–≤–µ—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ.
"""
        
        try:
            await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
            
            response = self.gemini_model.generate_content(prompt)
            await update.message.reply_text(response.text)
            
            self.user_contexts[user_id].append(f"–ë–æ—Ç: {response.text}")
            await self.add_experience(user_data, 1)
        except Exception as e:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.")
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –∫–æ–º–∞–Ω–¥—É memorydel
    async def memorydel_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        self.db.log_command(user_data.user_id, "/memorydel")
        
        if not context.args:
            await update.message.reply_text("üß† /memorydel [–∫–ª—é—á]")
            return
        
        key = context.args[0]
        if key in user_data.memory_data:
            del user_data.memory_data[key]
            self.db.save_user(user_data)
            await update.message.reply_text(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ: {key}")
        else:
            await update.message.reply_text(f"‚ùå –ö–ª—é—á '{key}' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        
        await self.add_experience(user_data, 1)

    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–∫—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è)
    async def note_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        if not context.args:
            await update.message.reply_text("üìù /note [—Ç–µ–∫—Å—Ç]")
            return
        note = " ".join(context.args)
        user_data.notes.append(note)
        self.db.save_user(user_data)
        await update.message.reply_text("‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!")
        await self.add_experience(user_data, 1)

    async def notes_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_data = await self.get_user_data(update)
        if not user_data.notes:
            await update.message.reply_text("‚ùå –ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫!")
            return
        notes_text = "\n".join(f"{i+1}. {note}" for i, note in enumerate(user_data.notes))
        await update.message.reply_text(f"üìù –ó–∞–º–µ—Ç–∫–∏:\n{notes_text}")

    # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —Å–º. –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ...
    # –ò–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –ø–æ–∫–∞–∑–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

    async def run_bot(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        if not BOT_TOKEN:
            logger.error("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return

        application = (
            Application.builder()
            .token(BOT_TOKEN)
            .read_timeout(30)
            .write_timeout(30)
            .connect_timeout(30)
            .pool_timeout(30)
            .build()
        )
        
        async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞: {context.error}")
            
            if isinstance(context.error, telegram.error.Conflict):
                logger.error("–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤")
                await asyncio.sleep(30)
        
        application.add_error_handler(error_handler)
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        application.add_handler(CommandHandler("start", self.start_command))
        application.add_handler(CommandHandler("help", self.help_command))
        application.add_handler(CommandHandler("info", self.info_command))
        application.add_handler(CommandHandler("status", self.status_command))
        application.add_handler(CommandHandler("ai", self.ai_command))
        application.add_handler(CommandHandler("note", self.note_command))
        application.add_handler(CommandHandler("notes", self.notes_command))
        application.add_handler(CommandHandler("memorydel", self.memorydel_command))
        # ... –¥–æ–±–∞–≤—å—Ç–µ –≤—Å–µ –æ—Å—Ç
